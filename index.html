<html>
  <head>
    <script src="jquery-1.7.1.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <style type="text/css"> 
      .control {
        text-align:left; 
      }
    </style>
    <script type="text/javascript">

      google.load('visualization', '1.0', {'packages':['corechart', 'charteditor']});
      google.setOnLoadCallback(wrapper);

      var settings = {
          width: 940
        , height: 400
        , uri: "http://r.staging.onescreen.net/analytics/contentimpression/1202584"
        , el: "graph"
        , title: 'Impression vs Time Line Chart'
        , legend: 'none' 
        , chartType: 'LineChart'
        , allowHtml: true 
        , pointSize: 5
      };
      
      var wrapper; // Google Chartwrapper object

      function main() {
        // by default, show 7 days data
        var mode, start, end; 

        end = new Date(2012, 02, 9); 
        start = add_days(end, -7);
        
        var query = construct_query(start, end);
        load(query);

        $("#prev").click(function() {
          end = start; 
          start = add_days(end, -7);

          var query = construct_query(start, end); 
          load(query);
        });
          
        $("#next").click(function() {
          start = end; 
          end = add_days(start, 7);
          
          var query = construct_query(start, end); 
          load(query);
        });
        
        $("#today").click(function() {
          end = new Date(2012, 02, 9); 
          start = add_days(end, -7);
          
          var query = construct_query(start, end);
          load(query);
        });
      }
      
      /** Add/ Substract days from a Date
       *    Accepts {Date} date
       *            {Integer} days 
       *    Returns {Date} 
       *  To add, use positive integer
       *  To substract, use negative integer
       */  
      var add_days = function(date, days) {
        var result = new Date(date);
        result.setDate(date.getDate() + days); 
        return result;
      }
      
      /** Generate a specific date string format to the server
       *    Accepts {Date} 
       *    Returns {String} i.e. 2012-2-2-0000
       */  
      var date_format = function(date) {
        var query = date.getFullYear() + "-" + date.getMonth() + "-" + date.getDate() + "-0000";  
        return query;
      }
      
      /** Construct the query string to the server
       *    Accepts {Date} start
       *            {Date} end
       *    Returns {String} url
       */  
      var construct_query = function(start_date, end_date) {
        var start = date_format(start_date); 
        var end = date_format(end_date);
        return settings.uri + "?start=" + start + "&end=" + end;
      }
   
      /** Query the json data and generate line chart graph */
      var load = function(query) {
        $.getJSON(query, function (json) {
          if (json === null) {
            $("#" +settings.el).text("Error: No data!");
            return;
          }
          var data_table = create_datatable(json); 
        });
      }
      
      /** Convert Json data retrieved from the server to 
       *  Google's DataView object 
       *    Accept: {json} source
       *    Return: {DataView} dw 
       */     
      var create_datatable = function(source) {
        var dt = new google.visualization.DataTable();
        dt.addColumn('date', 'Date');
        dt.addColumn('number', 'Impressions');
        
        var count = source.count; 
        var dataPoints = source.dataPoints; 
        
        $.each(dataPoints, function (time, hit) {
          var t = new Date().valueOf(time);
              t = new Date(t); 
          dt.addRow([t, hit]);
        });

        var formatter = new google.visualization.DateFormat({formatType: 'medium'});
        formatter.format(dt, 0);
    
        var dataView = new google.visualization.DataView(dt);
        dataView.setColumns([{ calc: date_stringify, type: 'string' }, 1 ]);
      }
      
      var generate_wrapper = function(data_view) {
        wrapper = new google.visualization.ChartWrapper({
            chartType: settings.chartType;
          , dataType: data_view
          , containerId: settings.el
          , options: settings
        });
        
        wrapper.draw();
      }
      /** Format google.DataTable's value to string 
       *    Accept: {Google Data Table} data
       *            {Row index} row
       *  http://code.google.com/apis/chart/interactive/docs/customizing_axes.html#Discrete_vs_Continuous
       */
      var date_stringify = function(data, row) {
        var formatted = data.getFormattedValue(row, 0); 
        return formatted.substring(0, formatted.indexOf(','));
      }

      function openEditor(){
        var editor = new google.visualization.ChartEditor();
        google.visualization.events.addListener(editor, 'ok', function() {
          wrapper = editor.getChartWrapper();
          wrapper.draw(document.getElementById('graph'));
        });
        editor.openDialog(wrapper);
      } 
    </script>
  </head>

  <body> 
    <div class="control">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <button id="today">Today</button>
      <button id="editor" onclick="openEditor()">Settings</button>
    </div>
    <div id="graph"></div>
  </body>
</html>
