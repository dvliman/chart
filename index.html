<html>
  <head>
    <script src="jquery-1.7.1.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">

      google.load('visualization', '1.1', {'packages':['controls', 'corechart', 'charteditor']});
      google.setOnLoadCallback(main);

      var settings = {
          width: 940
        , height: 400
     //   , uri: "data.json"
        , uri: "http://localhost:4567"
        , el: "graph"
        , title: 'Impression vs Time Line Chart'
        , legend: 'none' 
        , chartType: 'LineChart'
        , allowHtml: true 
        , pointSize: 5
      };
      
      var cwrapper; // Google Chartwrapper Object. Data Points are stored here

      function main() {

        var start = new Date(), end = new Date(), mode = "monthly"; 
        
        $("#daily, #weekly, #monthly, #yearly").bind('click', function() {
          mode = $(this).attr('id');
          end = start;
  
          if (mode === 'daily') start = add_hours(start, -24);
          if (mode === 'weekly') start = add_days(start,-7);
          if (mode === 'monthly') start = add_days(start, -30);
          if (mode === 'yearly') start = add_days(start, -365);
          
          load (construct_query(start, end, mode));        
        });
        
        $("#prev").click(function() {
          end = start;
  
          if (mode === 'daily') start = add_hours(start, -24);
          if (mode === 'weekly') start = add_days(start,-7);
          if (mode === 'monthly') start = add_days(start, -30);
          if (mode === 'yearly') start = add_days(start, -365);
          
          load (construct_query(start, end, mode));
        });
        
        $("#next").click(function() {
          start = end;
  
          if (mode === 'daily') end = add_hours(start, 24);
          if (mode === 'weekly') end = add_days(start, 7);
          if (mode === 'monthly') end = add_days(start, 30);
          if (mode === 'yearly') end = add_days(start, 365);
          
          load (construct_query(start, end, mode));
        });        
      }
      
      /** Add/Substract days from a Date
       *    @accepts {Date} date
       *             {Integer} days 
       *    @returns {Date} 
       *  To add, use positive integer
       *  To substract, use negative integer
       */  
      var add_days = function(date, days) {
        var result = new Date(date);
        result.setDate(date.getDate() + days); 
        return result;
      }
      
      /** Add/Substract hours from a Date
       *    @accepts {Date} date
       *             {Integer} hours 
       *    @returns {Date} 
       *  To add, use positive integer
       *  To substract, use negative integer
       */  
      var add_hours = function(date, hours) {
        var result = new Date(date);
        result.setDate(date.getHours() + hours); 
        return result;
      }
      
      /** Generate a specific date string format to the server
       *    @accepts {Date} 
       *    @returns {String} i.e. 2012-2-2-0000
       */  
      var date_format = function(date) {
        var query = date.getFullYear() + "-" + date.getMonth() + "-" + date.getDate() + "-0000";  
        return query;
      }
      
      /** Construct the query string to the server
       *    @accepts {Date} start
       *             {Date} end
       *    @returns {String} url
       */  
      var construct_query = function(start_date, end_date, mode) {
        var start = date_format(start_date); 
        var end = date_format(end_date);
        return settings.uri + "?start=" + start + "&end=" + end + "&mode=" + mode;
      }
   
      /** Get the json data and generate the graph via Google ChartWrapper */
      var load = function(query) {
        console.log(query);
        return;
        $.getJSON(query, function (json) {
          if (json === null) {
            $("#" +settings.el).text("Error: No data!");
            return;
          }
          
          var data = create_datatable(json);
          
          cwrapper = new google.visualization.ChartWrapper({
              chartType: settings.chartType
            , dataTable: data
            , containerId: settings.el
            , options: settings
            , view: {'columns': [0,1]}
          });
          cwrapper.draw();
        });
      }
      
      /** Convert Json data retrieved from the server to 
       *  Google's DataView object 
       *    @accept: {json} source
       *    @return: {DataView} dataView
       */     
      var create_datatable = function(source) {
        var dt = new google.visualization.DataTable();
        dt.addColumn('string', 'Date');
        dt.addColumn('number', 'Impressions');
        
        var count = source.count; 
        var dataPoints = source.dataPoints; 
        
        $.each(dataPoints, function (){
          dt.addRow([this.time, this.hits]);
        });
        
        return dt;
      }
    </script>
  </head>

  <body> 
    <div id="control">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <button id="today">Today</button>
       
      <button id="daily">Daily</button>
      <button id="weekly">Weekly</button>
      <button id="monthly">Monthly</button>
      <button id="yearly">Yearly</button>
      
      <div id="graph"></div>
    </div>
    
  </body>
</html>
