<html>
  <head>
    <script src="jquery-1.7.1.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript">

      google.load('visualization', '1.1', {'packages':['controls', 'corechart', 'charteditor']});
      google.setOnLoadCallback(main);

      var settings = {
          width: 940
        , height: 400
        , uri: "data.json"
     //   , uri: "http://localhost:4567"
     //   , uri: "http://r.staging.onescreen.net/analytics/contentimpression/1202584"
        , el: "graph"
        , title: 'Impression vs Time Line Chart'
        , legend: 'none' 
        , chartType: 'LineChart'
        , allowHtml: true 
        , pointSize: 5
        , view: {'columns': [0,1]}
      };
      
      var cwrapper; // Google Chartwrapper Object. Data Points are stored here
      var dashboard; 
      var picker; 
      
      function main() {
        // by default, show 7 days data
        var start, end; 
        end = new Date(2012, 02, 9); 
        start = add_days(end, -7);
        
        var query = construct_query(start, end);
        load(query);

        $("#prev").click(function() {
          end = start; 
          start = add_days(end, -7);
          var query = construct_query(start, end); 
          load(query);
        });
          
        $("#next").click(function() {
          start = end; 
          end = add_days(start, 7);
          var query = construct_query(start, end); 
          load(query);
        });
        
        $("#today").click(function() {
          end = new Date(2012, 02, 9); 
          start = add_days(end, -7);
          var query = construct_query(start, end);
          load(query);
        });
      }
      
      /** Add/ Substract days from a Date
       *    @accepts {Date} date
       *            {Integer} days 
       *    @returns {Date} 
       *  To add, use positive integer
       *  To substract, use negative integer
       */  
      var add_days = function(date, days) {
        var result = new Date(date);
        result.setDate(date.getDate() + days); 
        return result;
      }
      
      /** Generate a specific date string format to the server
       *    @accepts {Date} 
       *    @returns {String} i.e. 2012-2-2-0000
       */  
      var date_format = function(date) {
        var query = date.getFullYear() + "-" + date.getMonth() + "-" + date.getDate() + "-0000";  
        return query;
      }
      
      /** Construct the query string to the server
       *    @accepts {Date} start
       *            {Date} end
       *    @returns {String} url
       */  
      var construct_query = function(start_date, end_date) {
        var start = date_format(start_date); 
        var end = date_format(end_date);
        return settings.uri + "?start=" + start + "&end=" + end;
      }
   
      /** Get the json data and generate the graph via Google ChartWrapper */
      var load = function(query) {
        $.getJSON(query, function (json) {
          if (json === null) {
            $("#" +settings.el).text("Error: No data!");
            return;
          }
          
          var data = create_datatable(json);
          
          cwrapper = new google.visualization.ChartWrapper({
              chartType: settings.chartType
            , dataTable: data
            , containerId: settings.el
            , options: settings
            , view: {'columns': [0,1]}
          });
          
          picker = new google.visualization.ControlWrapper({
            'controlType': 'CategoryFilter',
            'containerId': 'picker',
            'options': {
              'filterColumnLabel': 'Mode',
              'ui': {
                'labelStacking': 'vertical',
                'allowTyping': false,
                'allowMultiple': false    
              }
            }
          });
          
          dashboard = new google.visualization.Dashboard(document.getElementById('control'));
          dashboard.bind(picker, cwrapper);
          dashboard.draw(data);
        });
      }
      
      /** Convert Json data retrieved from the server to 
       *  Google's DataView object 
       *    @accept: {json} source
       *    @return: {DataView} dataView
       */     
      var create_datatable = function(source) {
        var dt = new google.visualization.DataTable();
        dt.addColumn('string', 'Date');
        dt.addColumn('number', 'Impressions');
        dt.addColumn('string', 'Mode');
        
        var count = source.count; 
        var dataPoints = source.dataPoints; 
        
        $.each(dataPoints, function (){
          //var t = new Date().valueOf(this.time);
          //    t = new Date(t); 
          dt.addRow([this.time, this.hits, this.type]);
        });

        /* apply formatter for "date" data
        var formatter = new google.visualization.DateFormat({formatType: 'medium'});
        formatter.format(dt, 0);
    
        var dataView = new google.visualization.DataView(dt);
        dataView.setColumns([{ calc: date_stringify, type: 'string' }, 0 ]);
        */
        return dt;
      }
      
      /** Format google.DataTable's value to string 
       *    @accept: {Google Data Table} data
       *            {Row index} row
       *  http://code.google.com/apis/chart/interactive/docs/customizing_axes.html#Discrete_vs_Continuous
       */
      var date_stringify = function(data, row) {
        var formatted = data.getFormattedValue(row, 0); 
        return formatted.substring(0, formatted.indexOf(','));
      }

      /** An editor to change different type of chart displays */
      function openEditor(){
        var editor = new google.visualization.ChartEditor();
        google.visualization.events.addListener(editor, 'ok', function() {
          cwrapper = editor.getChartWrapper();
          cwrapper.draw(document.getElementById(settings.el), settings);
          dashboard.bind(picker, cwrapper);
        });
        editor.openDialog(cwrapper);
      }

    </script>
  </head>

  <body> 
    <div id="control">
      <button id="prev">Prev</button>
      <button id="next">Next</button>
      <button id="today">Today</button>
      <button id="editor" onclick="openEditor()">Settings</button>
      <div id="picker"></div>
      <div id="graph"></div>
    </div>
    
  </body>
</html>
